
<html>
	<style>
		canvas {
			width: 500px;
			height: 500px;
			position: absolute;
			top: 0; left: 0; right: 0; bottom: 0;
			margin: auto;
			
			border: 1px solid black;
		}
	</style>
	<body>
		<canvas id="pesho" width="500px" height="500px"></canvas>
	
		<script>
			var canvas = document.getElementById("pesho"),
				context = canvas.getContext("2d");
			
			function map(x, a, b, c, d) {
				var coef = (x - a) / (b - a),
					res = c + coef * (d - c);
					
				if (res < c)
					return c;
				if (res > d)
					return d;
				return res;
			}
			
			var V = [function (x, y) { return [x, y]; },
					function (x, y) { return [Math.sin(x), Math.cos(y)]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y); return [x / (r * r), y / (r * r)]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [r * Math.cos(theta + r), r * Math.sin(theta + r)]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [r * Math.cos(2 * theta), r * Math.sin(2 * theta)]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [theta / Math.PI, r - 1]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [r * Math.sin(theta + r), r * Math.cos(theta - r)]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [r * Math.sin(theta * r), -r * Math.cos(theta * r)]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [theta * Math.sin(Math.PI * r) / Math.PI, theta * Math.cos(Math.PI * r) / Math.PI]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [(Math.cos(theta) + Math.sin(r)) / r, (Math.sin(theta) - Math.cos(r)) / r]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [Math.sin(theta) / r, Math.cos(theta) / r]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [Math.sin(theta) * Math.cos(r), Math.cos(theta) * Math.sin(r)]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [Math.sin(theta) / r, Math.cos(theta) / r]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [r * Math.pow(Math.sin(theta, + r), 3), r * Math.pow(Math.cos(theta - r), 3)]; },
					function (x, y) { var r = Math.sqrt(x * x + y * y), theta = Math.atan(y / x); return [Math.sqrt(r) * Math.cos(theta / 2 + (Math.random() > 0.5 ? 0 : Math.PI)), Math.sqrt(r) * Math.sin(theta / 2 + (Math.random() > 0.5 ? 0 : Math.PI))]; },
				
					],
				F = [
					
					function (x, y) { return [x / 2, y / 2]; },
					function (x, y) { return [(x + 1) / 2, y / 2]; },
					function (x, y) { return [x / 2, (y + 1) / 2]; },
				],
				fCoef = [
					{ a: 0.562482, b: 0.397861, c: -0.539599, d: 0.501088, e: -0.42992, f: -0.112404, w: 0.5 },
					{ a: 0.830039, b: -0.496174, c: 0.16248, d: 0.750468, e: 0.91022, f: 0.288389, w: 0.5 },
				];
				
			function setColor(r, g, b, a) {
				if (!a) a = 1;
				context.fillStyle = "rgba(" + ~~r + "," + ~~g + "," + ~~b + "," + a + ")";
				context.strokeStyle = "rgba(" + ~~r + "," + ~~g + "," + ~~b + "," + a + ")";
			}
				
			var x = 0.5, y = 0.5,
				count = 10000,
				repeatCount = 45000,
				repeat = 0,
				histogram = [],
				histogramMax = 0,
				rendered = false;
				
			for (var i = 0; i <= canvas.height; ++ i) {
				histogram[i] = [];
				for (var k = 0; k <= canvas.width; ++ k) {
					histogram[i][k] = 0;
				}
			}
			
			x = -1 + Math.random() * 2;
			y = -1 + Math.random() * 2;
			
			function render() {
				//context.fillRect(0, 0, canvas.width, canvas.height);
				if (rendered)
					return;
					
				rendered = true;
				
				context.clearRect(0, 0, canvas.width, canvas.height);
				console.log("rendering...");
				
				for (var i = 0; i < canvas.height; ++ i) {
					for (var k = 0; k < canvas.width; ++ k) {
						//if (histogram[k][i] != 0) {
							//console.log("A");
							setColor(0, 0, map(histogram[k][i], 0, histogramMax / 600, 0, 255));
							context.fillRect(k, i, 1, 1);
						//}
					}
				}
			}
			
			var iterate = function () {
				var i = ~~(Math.random() * V.length);
				//console.log(i);
				
				if (count >= 20) {
					histogram[~~map(x, -1, 1, 0, canvas.width)][~~map(y, -1, 1, 0, canvas.height)] += 1; 
					if (histogram[~~map(x, -1, 1, 0, canvas.width)][~~map(y, -1, 1, 0, canvas.height)] > histogramMax)
						histogramMax = histogram[~~map(x, -1, 1, 0, canvas.width)][~~map(y, -1, 1, 0, canvas.height)];
				}	
				//context.fillRect(map(x, -1, 1, 0, 400), map(y, -1, 1, 0, 400), 1, 1);
				
				var res = V[i](fCoef[0].a * x + fCoef[0].b * y + fCoef[0].c, fCoef[0].d * x + fCoef[0].e * y + fCoef[0].f);
				var res2 = V[i](fCoef[1].a * x + fCoef[1].b * y + fCoef[1].c, fCoef[1].d * x + fCoef[1].e * y + fCoef[1].f);
				res[0] = (res[0] + res2[0]) / 2;
				res[1] = (res[1] + res2[1]) / 2;
				
				x = res[0];
				y = res[1];
				
				if (repeat <= repeatCount) {
					setTimeout(iterate, 0);
					setTimeout(iterate, 0);
					setTimeout(iterate, 0);
					setTimeout(iterate, 0);
					setTimeout(iterate, 0);
				} else render();
				repeat ++;
			}
			
			/*
			iterate = function () {
				for (var x = 0; x <= 1.0; x += 0.005) {
					for (var y = 0; y <= 1.0; y += 0.005) {
						
						var p = Math.random(),
							res;
						
						for (var i = 0; i < flameCoef.length; ++ i) {
							if (i == 0 && p <= flameCoef[i].p) {
								res = flameFunction(x, y, i);
								break;
							}
							else if (i != 0 && p > flameCoef[i - 1].p && p <= flameCoef[i].p) {
								res = flameFunction(x, y, i);
								break;
							}
						}
						
						//console.log("wtf: " + x + " : " + y);
						
						var r = res[0];
						var g = res[1];
						
						setColor(map(r, 0, 1, 0, 255), map(g, 0, 1, 0, 255), 0);
						context.fillRect(map(x, 0, 1, 0, 500), map(y, 0, 1, 0, 500), 3, 3);
					}
				}
			}*/
			
			iterate();
		</script>
	</body>
</html>
