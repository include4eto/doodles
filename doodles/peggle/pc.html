<!DOCTYPE html>
<html>
    <head>
        <title>Peggle</title>
        <style>
            canvas {
                border: 1px solid black;
                width: 800px;
                height: 600px;
            }
        </style>
    </head>

    <body>
        <canvas id="my-canvas" width="800px" height="600px"></canvas>

        <script>
            var canvas = document.getElementById("my-canvas"),
                context = canvas.getContext("2d"),
                ballsCount = 100;

            var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                                        window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
            window.requestAnimationFrame = requestAnimationFrame;

            function Vector(x, y) {
                this.x = x;
                this.y = y;

                this.add = function (vec) {
                    this.x += vec.x;
                    this.y += vec.y;
                }

                this.magnitude = function () {
                    return Math.sqrt(this.x * this.x + this.y * this.y);
                }
            }

            function Ball(x, y, radius, colour) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.velocity = new Vector(0, 0);
                this.colour = colour;
				this.wetness = 0;

                this.draw = function () {
                    context.strokeStyle = this.colour;
                    context.beginPath();
                        context.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
                    context.stroke();
					
					context.fillStyle = "rgba(0, 123, 255," + (this.wetness > 12800 ? 128 : this.wetness / 100) + ")";
					context.beginPath();
						context.arc(this.x, this.y, this.radius + 3, -Math.PI, 
							(this.wetness >= 400 ? 2 : this.wetness / 50) * Math.PI);
					context.fill();
                };

                this.update = function () {
                    this.x += this.velocity.x;
                    this.y += this.velocity.y;
					if (this.wetness)
						this.wetness -= 10;
                }
            }

			function Explosion(particleCount, decayTime) {
				var particles = [],
					gravity = new Vector(0, 0.2),
					timeToLive = decayTime;
				
				this.start = function () {
					update();
				}
				
				this.draw = function (context, location) {
					context.save();
					{
						context.translate(location.x, location.y);
						
						for (var i in particles) {
							var particle = particles[i];
							
							//context.strokeStyle = "rgb(" + particle.color.r + "," +
							//	particle.color.g + "," + particle.color.b + ")";
							context.fillStyle = "rgba(0, 0, 255, 1)";
							
							//context.beginPath();
							//context.arc(particle.location.x, particle.location.y,
							//	1, 0, Math.PI * 2);
							//context.fill();
							
							context.fillRect(particle.location.x, particle.location.y,
								1, 3);
						}
					}
					context.restore();
				}
				
				var frameCount = 0;
				function update() {
					frameCount++;
					for (var i = 0; i < 1; ++ i) {
						particles.push({
							location: new Vector(-400 + Math.random() * 800, 0),
							velocity: new Vector(0, 0),
							color: {r: parseInt(Math.random() * 255),
								g: parseInt(Math.random() * 255),
								b: parseInt(Math.random() * 255)
							},
							size: 1
						});
					}
					
					for (var i in particles) {
						var particle = particles[i];
						if (particle.location.x < -700 || particle.location.x > 700 ||
							particle.location.y < -600 || particle.location.y > 600) {
							particles.shift();
							continue;
						}
						
						var ballc = balls.concat(myBalls);
						for (var k in ballc) {
							var ball = ballc[k],
								dx = ball.x - (particle.location.x + 400),
								dy = ball.y - (particle.location.y - 10),
								dist = Math.sqrt(dx * dx + dy * dy);
								
							if (dist <= ball.radius + 1) {
								ball.wetness += 1;
								break;
							}
						}
						
						particle.velocity.add(gravity);
						particle.location.add(particle.velocity);
					}
					
					setTimeout(update, 30);
				}
			}
			
            var myBalls = [new Ball(400, 10, 10, "black")],
                gravity = new Vector(0, 0.2),
                launcher = new Vector(0, 0);
                
            var balls = [];
            for (var i = 0; i < ballsCount; i++) {
				var x = 10 + Math.random() * 790,
					y = Math.random() * 400 + 100;
				var collides = false;
					
				for (var ball in balls) {
					var curBall = balls[ball],
						dx = x - curBall.x,
						dy = y - curBall.y,
						dist = Math.sqrt(dx * dx + dy * dy);
					
					if (dist <= 30) {
						collides = true;
						break;
					}
				}
				
				if (collides) {
					i--;
					continue;
				}
			
                balls.push(new Ball(x, y, 10, "red"));
            }

            function launch() {
                var myBall = new Ball(400, 10, 10, "black");
				myBall.velocity.x = (launcher.x - canvas.width / 2 + 5) / (53 - power);
				myBall.velocity.y = launcher.y / (53 - power);
				
				myBall.x = launcher.x;
				myBall.y = launcher.y;
				
				myBalls.push(myBall);
				power = 0;
				held = false;
			}

			window.onmousemove = function (touch) {
				touch.preventDefault();
			
				var mouse = touch;
			
				var dx = mouse.clientX - canvas.width / 2 + 5,
					dy = mouse.clientY,
					dist = Math.sqrt(dx * dx + dy * dy);
						
				var sin = dy / dist, cos = dx / dist,
					rX = cos * (dist - 100),
					rY = sin * (dist - 100);

                launcher.x = mouse.clientX - rX;
                launcher.y = mouse.clientY - rY;
			}
				
			window.onmousedown = function (mouse) {
				held = true;
			}
			
			window.onmouseup = function (mouse) {
				if (held)
					launch();
				held = false;
			}
			
			var power = 0,
				state = 0,
				held = false;
			
			var collisions = [];
            function update() {
				if (held) power++;
				if (power >= 50)
					launch();
				
				for (var ball in myBalls) {
				    var myBall = myBalls[ball];
				    myBall.velocity.add(gravity);

				    myBall.update();
				    for (var ball in balls) {
				        var curBall = balls[ball],
                            dx = myBall.x - curBall.x,
                            dy = myBall.y - curBall.y,
                            dist = Math.sqrt(dx * dx + dy * dy),
							wetness = ((curBall.wetness) / 20) + 0.5,
                            magnitude = myBall.velocity.magnitude() * 0.8;

				        var sin = dy / dist, cos = dx / dist,
                            targetR = myBall.radius + curBall.radius,
                            rX = cos * targetR,
                            rY = sin * targetR;

				        if (targetR >= dist) {
				            collisions.push([curBall.x + rX, curBall.y + rY]);
				            myBall.x = curBall.x + rX;
				            myBall.y = curBall.y + rY;

				            myBall.velocity.x = (dx / dist) * magnitude;
				            myBall.velocity.y = (dy / dist) * magnitude;
				        }
				    }

				    if (myBall.x + myBall.radius >= canvas.width) {
				        myBall.x = canvas.width - myBall.radius;
				        myBall.velocity.x *= -0.7;
				        myBall.velocity.y *= 0.7;
				    }

				    if (myBall.x < 0) {
				        myBall.x = myBall.radius;
				        myBall.velocity.x *= -0.7;
				        myBall.velocity.y *= 0.7;
				    }

				    if (myBall.y + myBall.radius >= canvas.height) {
				        myBall.y = canvas.height - myBall.radius;
				        myBall.velocity.y *= -0.7;
				        myBall.velocity.x *= 0.7;
				    }

				    if (myBall.y < 0) {
				        myBall.y = myBall.radius;
				        myBall.velocity.y *= -0.7;
				        myBall.velocity.x *= 0.7;
				    }
				}
                setTimeout(update, 1000 / 60);
            }

			var explosion = new Explosion(1000, 1);
			explosion.start();
			var explosionLocation = new Vector(400, -10);
			
            function render() {
				context.fillStyle = "rgba(255, 255, 255, 0.7)";
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                context.fillStyle = "black";

				explosion.draw(context, explosionLocation);
				
                context.beginPath();
                    context.moveTo(canvas.width / 2, 0);
                    context.lineTo(launcher.x, launcher.y);
                context.stroke();

                context.lineWidth = 2;

                for (var ball in myBalls)
                    myBalls[ball].draw(context);

                for (var ball in balls) {
                    balls[ball].draw();
                }
			
				//context.strokeStyle = "blue";
                //context.beginPath();
				//for (var x in collisions) {
				//	//context.strokeRect(collisions[x][0], collisions[x][1], 10, 10);
				//	context.arc(collisions[x][0], collisions[x][1],
				//		10, 0, Math.PI * 2);
				//}
                //context.stroke();
				
				if (state == 0) {
					context.font = "20px Verdana";
					context.fillStyle = "black";
					context.fillText("Power", 700, 200);
					
					context.fillRect(730, 180 - power, 10, power);
				}


                requestAnimationFrame(render);
            }

            render();
            update();
        </script>
    </body>
</html>